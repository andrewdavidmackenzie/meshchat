name: Release Bundle

on:
  release:
    types: [ published ]

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1
  GH_TOKEN: ${{ github.token }}

jobs:
  build-and-bundle:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-15, windows-latest, windows-11-arm, ubuntu-24.04-arm ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install dependencies - Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt install libdbus-1-dev pkg-config

      - name: Install cargo bundle
        run: cargo install cargo-bundle

      - name: Build bundle for non-Windows
        if: runner.os != 'Windows'
        run: cargo bundle --release

      - name: Build bundle for Windows
        if: runner.os == 'Windows'
        run: cargo bundle --release --format msi

      - name: Find and prepare bundle artifacts
        id: find-bundles
        shell: bash
        run: |
          ARCH=$(echo "${{ runner.arch }}" | tr '[:upper:]' '[:lower:]')
          VERSION=$(echo "${{ github.event.release.tag_name }}" | tr '-' '_')
          if [ "${{ runner.os }}" == "Linux" ]; then
            BUNDLE_PATH=$(find target/release/bundle -name "*.AppImage" -o -name "*.deb" | head -1)
            BUNDLE_NAME=$(basename "$BUNDLE_PATH")
          elif [ "${{ runner.os }}" == "macOS" ]; then
            BUNDLE_PATH=$(find target/release/bundle -name "*.app" -type d | head -1)
            ORIGINAL_NAME=$(basename "$BUNDLE_PATH")
            BUNDLE_DIR=$(dirname "$BUNDLE_PATH")
            # Create a zip for macOS app bundle with architecture in name
            cd "$BUNDLE_DIR"
            BUNDLE_NAME="meshchat_${VERSION}_${ARCH}.app.zip"
            zip -r "$BUNDLE_NAME" "$ORIGINAL_NAME"
            BUNDLE_PATH="${BUNDLE_DIR}/${BUNDLE_NAME}"
          elif [ "${{ runner.os }}" == "Windows" ]; then
            BUNDLE_PATH=$(find target/release/bundle -name "*.msi" | head -1)
            ORIGINAL_NAME=$(basename "$BUNDLE_PATH")
            BUNDLE_NAME="meshchat_${VERSION}_${ARCH}.msi"
          fi
          echo "bundle_path=$BUNDLE_PATH" >> $GITHUB_OUTPUT
          echo "bundle_name=$BUNDLE_NAME" >> $GITHUB_OUTPUT
          echo "Found bundle: $BUNDLE_PATH"

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find-bundles.outputs.bundle_path }}
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}